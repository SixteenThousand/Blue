#!/bin/sh


swaybg_wrap() {
	killall swaybg
	swaybg --mode fill --image $1 & disown
	echo "swaybg --mode fill --image $1 & disown" > ~/.swaybg
	chmod +x ~/.swaybg
}

rewallpaper() {
	# cursed
	# resolution="$(xrandr | grep -F '*' | cut -d' ' -f 4)"
	# decide how to set wallpaper
	local new_wallpaper="$1"
	local cmd='feh --bg-fill'
	if [ "$XDG_CURRENT_DESKTOP" = KDE ]
	then
		cmd='plasma-apply-wallpaperimage --fill-mode preserveAspectCrop'
	elif pgrep swaybg >/dev/null 2>&1 || pgrep sway >/dev/null 2>&1
	then
		cmd=swaybg_wrap
	fi
	# detect whether new wallpaper has been set manually, and if not, find it
	if [ -z "$new_wallpaper" ]
	then
		local personal=$(find -L $HOME/Pictures/Wallpapers -type f)
		local desktops=$(find -L /usr/share/wallpapers -type f -name '1920x1080*' -o -name '5120x2880*')
		# this line broke when split
		new_wallpaper=$(echo -e "$personal\n$desktops" | fzf)
	fi
	# set wallpaper, if possible
	if [ -z "$new_wallpaper" ]
	then
		echo "No wallpaper selected!" >&2
		exit 1
	else
		$cmd $new_wallpaper
		echo -e "Wallpaper set to >>\e[1m$new_wallpaper\e[0m<<"
	fi
}

change_vol() {
	local SINK="@DEFAULT_SINK@"
	amixer sset Master "$2%$1"
	local VOLUME=$(pactl get-sink-volume $SINK \
		| sed -e '/.*balance.*/d;s/.* \([[:digit:]]\+\)%.*/\1/')
	notify-send \
		--app-name desktopctl \
		-t 600 \
		-h string:x-canonical-private-synchronous:volume \
		-h "int:value:$VOLUME" \
		-e \
		"Volume: $VOLUME%"
}

mute() {
	local SINK="@DEFAULT_SINK@"
	amixer sset Master toggle
	local MSG="Audio Unmuted!! Play that music, buddy!"
	case $(pactl get-sink-mute "$SINK") in
		*yes)
			MSG="Audio Muted."
			;;
	esac
	notify-send \
		--app-name desktopctl \
		-t 1000 \
		"$MSG"
}

# "main"
case $1 in
	-h|--help)
		cat <<- EOF
		Little script to change things about your desktop environment.
		
		Usage:
		    desktopctl bg [FILE]
		List available wallpapers and let you select one to be the new wallpaper
		using fzf. Should automatically detect how to set wallpaper, using one of:
		  - swaybg (wayland)
		  - feh (X11)
		  - plasma-apply-wallpaperimage (KDE Plasma desktop - could be X11 or wayland)
		DOES NOT automatically detect display resolution.
		Currently searches for wallpapers in ~/Pictures/Wallpapers and 
		/usr/share/wallpapers.
		  If FILE is provided, sets the wallpaper to FILE. FILE must be an absolute
		path. Detects setting method same as before.

		    desktopctl [mon|vol] [+|-] NUM
		Change monitor brightness/system volume by +/-NUM% and display a notification.
		If using dunst, will only display one notification even when used mulitple 
		times in a row.
		
		    desktopctl mute
		Mute system volume and display a notification

		    desktopctl autostart
		Open all apps specified by the desktop files in ~/.config/autostart
		
		Acknowledgement:
		The code for the volume changing commands is modelled on the volume-helper 
		script provided at /usr/libexec/sway/volume-helper in the Fedora distribution
		of sway.
		EOF
		exit
		;;
	bg)
		shift 1
		rewallpaper $@
		;;
	vol)
		shift 1
		change_vol $@
		;;
	mute)
		mute
		;;
	mon)
		shift 1
		brightnessctl -q set $2%$1
		VALUE=$(brightnessctl -q -P get)
		notify-send -e -t 600 \
			-h string:x-canonical-private-synchronous:brightness \
			-h "int:value:$VALUE" "Brightness: $VALUE%"
		;;
	autostart)
		autostart_dir=$HOME/.config/autostart
		for app in $(command ls $autostart_dir)
		do
			gio launch "$autostart_dir/$app"
		done
		;;
esac

# vim: expandtab=false, shiftwidth=4
